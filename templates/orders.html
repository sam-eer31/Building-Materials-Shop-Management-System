{% extends "base.html" %}

{% block title %}{{ t('orders') }} - {{ t('app_name') }}{% endblock %}
{% block page_title %}{{ t('order_management') }}{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
    <i class="fas fa-plus me-2"></i>{{ t('new_order') }}
</button>
{% endblock %}

{% block content %}
<!-- Search Bar -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" class="form-control" id="orderSearch" placeholder="{{ t('search_orders') }}">
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table" id="ordersTable">
                <thead>
                    <tr>
                        <th>{{ t('order_id') }}</th>
                        <th>{{ t('customer') }}</th>
                        <th>{{ t('order_date') }}</th>
                        <th>{{ t('delivery_date') }}</th>
                        <th>{{ t('amount') }}</th>
                        <th>{{ t('status') }}</th>
                        <th>{{ t('actions') }}</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    {% if orders %}
                        {% for order in orders %}
                        <tr data-order-id="{{ order.id }}">
                            <td>#{{ order.id }}</td>
                            <td>{{ order.customer.name }}</td>
                            <td>{{ order.order_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ order.delivery_date.strftime('%Y-%m-%d') if order.delivery_date else '-' }}</td>
                            <td>₹{{ "%.2f"|format(order.total_amount) }}</td>
                            <td>
                                <span class="badge {% if order.payment_status == 'Paid' %}bg-success{% elif order.payment_status == 'Partial' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {% if order.payment_status == 'Paid' %}{{ t('paid') }}{% elif order.payment_status == 'Partial' %}{{ t('partial') }}{% else %}{{ t('unpaid') }}{% endif %}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-order" 
                                        data-order-id="{{ order.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary edit-order-status" 
                                        data-order-id="{{ order.id }}"
                                        data-status="{{ order.payment_status }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="/invoice/{{ order.id }}" class="btn btn-sm btn-outline-success" title="Generate Invoice">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger delete-order" 
                                        data-order-id="{{ order.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                    <p class="mb-0">{{ t('no_orders_found') }}</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Order Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('add_new_order') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addOrderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderCustomer" class="form-label">{{ t('customer') }} *</label>
                                <select class="form-select" id="orderCustomer" required>
                                    <option value="">{{ t('select_customer') }}</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderDate" class="form-label">{{ t('order_date') }} *</label>
                                <input type="date" class="form-control" id="orderDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deliveryDate" class="form-label">{{ t('delivery_date') }}</label>
                                <input type="date" class="form-control" id="deliveryDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="paymentStatus" class="form-label">{{ t('payment_status') }}</label>
                                <select class="form-select" id="paymentStatus">
                                    <option value="Unpaid">{{ t('unpaid') }}</option>
                                    <option value="Partial">{{ t('partial') }}</option>
                                    <option value="Paid">{{ t('paid') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row" id="paymentAmountRow" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="paymentAmount" class="form-label">{{ t('payment_amount') }} *</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0">
                                </div>
                                <small class="text-muted">
                                    Total Order Amount: <span id="paymentTotalAmount">₹0.00</span>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label">{{ t('payment_method') }}</label>
                                <select class="form-select" id="paymentMethod">
                                    <option value="Cash">{{ t('cash') }}</option>
                                    <option value="Bank Transfer">{{ t('bank_transfer') }}</option>
                                    <option value="Check">{{ t('cheque') }}</option>
                                    <option value="Credit Card">{{ t('upi') }}</option>
                                    <option value="Other">{{ t('other') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deliveryAddress" class="form-label">{{ t('delivery_address') }}</label>
                        <textarea class="form-control" id="deliveryAddress" rows="2"></textarea>
                    </div>
                    
                    <hr>
                    <h6>{{ t('order_items') }}</h6>
                    
                    <div id="orderItems">
                        <div class="order-item row mb-2">
                            <div class="col-md-4">
                                <select class="form-select product-select" required>
                                    <option value="">Select Product</option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}" data-price="{{ product.price }}" data-stock="{{ product.stock_quantity }}">
                                        {{ product.name }} - ₹{{ "%.2f"|format(product.price) }} (Stock: {{ product.stock_quantity }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control quantity-input" placeholder="Qty" min="1" required>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control price-display" placeholder="Price" readonly>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control total-display" placeholder="Total" readonly>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addOrderItem">
                        <i class="fas fa-plus me-2"></i>Add Item
                    </button>
                    
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Total Amount: <span id="orderTotal" class="text-primary">₹0.00</span></h5>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveOrderBtn">
                    <i class="fas fa-save me-2"></i>Create Order
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Edit Order Status Modal -->
<div class="modal fade" id="editOrderStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Payment Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderStatusForm">
                    <input type="hidden" id="editOrderId">
                    <div class="mb-3">
                        <label for="editPaymentStatus" class="form-label">Payment Status</label>
                        <select class="form-select" id="editPaymentStatus">
                            <option value="Unpaid">Unpaid</option>
                            <option value="Partial">Partial</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateOrderStatusBtn">
                    <i class="fas fa-save me-2"></i>Update Status
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this order?</p>
                <div id="deleteOrderWarning" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Deleting this order will:
                    <ul class="mb-0 mt-2">
                        <li>Delete all associated order items</li>
                        <li>Delete all associated payment records</li>
                        <li>Restore stock quantities for all products in the order</li>
                    </ul>
                </div>
                <p class="text-danger">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteOrderBtn">
                    <i class="fas fa-trash me-2"></i>Delete Order
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let orders = [];
    let customers = [];
    let products = [];
    
    // Set default order date to today
    $('#orderDate').val(new Date().toISOString().split('T')[0]);
    
    // Load data on page load
    loadOrders();
    loadCustomers();
    loadProducts();
    
    // Search functionality
    $('#orderSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        filterOrders(searchTerm);
    });
    
    // Add order item
    $('#addOrderItem').click(function() {
        const newItem = `
            <div class="order-item row mb-2">
                <div class="col-md-4">
                    <select class="form-select product-select" required>
                        <option value="">Select Product</option>
                        ${products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock_quantity}">
                            ${p.name} - ₹${p.price.toFixed(2)} (Stock: ${p.stock_quantity})
                        </option>`).join('')}
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control quantity-input" placeholder="Qty" min="1" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control price-display" placeholder="Price" readonly>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control total-display" placeholder="Total" readonly>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-item">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        $('#orderItems').append(newItem);
    });
    
    // Reset form when modal is opened
    $('#addOrderModal').on('show.bs.modal', function() {
        // Reset payment fields
        $('#paymentAmount').val('');
        $('#paymentStatus').val('Unpaid');
        $('#paymentAmountRow').hide();
        $('#orderTotal').text('₹0.00');
        calculateOrderTotal();
        
        // Ensure payment amount field is hidden initially
        $('#paymentAmountRow').hide();
    });
    
    // Remove order item
    $(document).on('click', '.remove-item', function() {
        if ($('.order-item').length > 1) {
            $(this).closest('.order-item').remove();
            calculateOrderTotal();
        }
    });
    
    // Product selection change
    $(document).on('change', '.product-select', function() {
        const selectedOption = $(this).find('option:selected');
        const price = parseFloat(selectedOption.data('price')) || 0;
        const stock = parseInt(selectedOption.data('stock')) || 0;
        
        const item = $(this).closest('.order-item');
                        item.find('.price-display').val(`₹${price.toFixed(2)}`);
        item.find('.quantity-input').attr('max', stock);
        
        calculateOrderTotal();
    });
    
    // Quantity change
    $(document).on('input', '.quantity-input', function() {
        calculateOrderTotal();
    });
    
    // Payment status change
    $('#paymentStatus').change(function() {
        const status = $(this).val();
        const totalAmount = parseFloat($('#orderTotal').text().replace('₹', '')) || 0;
        
        if (status === 'Partial') {
            // Show payment amount field for partial payments
            $('#paymentAmountRow').show();
            $('#paymentTotalAmount').text(`₹${totalAmount.toFixed(2)}`);
            $('#paymentAmount').val('');
            $('#paymentAmount').removeAttr('readonly');
        } else if (status === 'Paid') {
            // Hide payment amount field for paid orders (auto-set to total)
            $('#paymentAmountRow').hide();
            $('#paymentAmount').val(totalAmount.toFixed(2));
        } else {
            // Hide payment amount field for unpaid orders
            $('#paymentAmountRow').hide();
            $('#paymentAmount').val('');
        }
    });
    
    // Payment amount change - auto-update status and validate
    $('#paymentAmount').on('input', function() {
        const paymentAmount = parseFloat($(this).val()) || 0;
        const totalAmount = parseFloat($('#orderTotal').text().replace('₹', '')) || 0;
        const currentStatus = $('#paymentStatus').val();
        
        // Update outstanding amount display
        const outstanding = totalAmount - paymentAmount;
        if (outstanding >= 0) {
            $('#paymentTotalAmount').html(`₹${totalAmount.toFixed(2)}<br><small class="text-muted">Outstanding: ₹${outstanding.toFixed(2)}</small>`);
        }
        
        // Auto-change status to Paid if payment equals or exceeds total
        const tolerance = 0.01; // Small tolerance for floating-point comparison
        if (paymentAmount >= (totalAmount - tolerance) && currentStatus === 'Partial') {
            $('#paymentStatus').val('Paid');
            $(this).attr('readonly', true);
        } else if (paymentAmount < totalAmount && currentStatus === 'Paid') {
            $('#paymentStatus').val('Partial');
            $(this).removeAttr('readonly');
        }
        
        // Validate payment amount
        if (paymentAmount > (totalAmount + tolerance)) {
            $(this).addClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
            $(this).after('<div class="invalid-feedback">Payment amount cannot exceed total order amount</div>');
        } else {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
        }
    });
    
    // Create order
    $('#saveOrderBtn').click(function() {
        const orderData = {
            customer_id: parseInt($('#orderCustomer').val()),
            order_date: $('#orderDate').val(),
            delivery_date: $('#deliveryDate').val() || null,
            delivery_address: $('#deliveryAddress').val(),
            payment_status: $('#paymentStatus').val(),
            payment_amount: parseFloat($('#paymentAmount').val()) || 0,
            payment_method: $('#paymentMethod').val(),
            items: []
        };
        
        // Validate customer
        if (!orderData.customer_id) {
            showAlert('Please select a customer.', 'danger');
            return;
        }
        
        // Collect order items
        $('.order-item').each(function() {
            const productId = $(this).find('.product-select').val();
            const quantity = parseInt($(this).find('.quantity-input').val());
            
            if (productId && quantity) {
                orderData.items.push({
                    product_id: parseInt(productId),
                    quantity: quantity
                });
            }
        });
        
        if (orderData.items.length === 0) {
            showAlert('Please add at least one item to the order.', 'danger');
            return;
        }
        
        // Handle payment amount based on status
        const totalAmount = parseFloat($('#orderTotal').text().replace('₹', '')) || 0;
        
        if (orderData.payment_status === 'Partial') {
            // For partial payments, validate the entered amount
            if (!orderData.payment_amount || orderData.payment_amount <= 0) {
                showAlert('Please enter a valid payment amount for partial payment.', 'danger');
                return;
            }
            
            const tolerance = 0.01; // Small tolerance for floating-point comparison
            if (orderData.payment_amount > (totalAmount + tolerance)) {
                showAlert('Payment amount cannot exceed total order amount.', 'danger');
                return;
            }
            
            if (orderData.payment_amount >= (totalAmount - tolerance)) {
                // If partial amount equals or exceeds total, change to Paid
                orderData.payment_status = 'Paid';
                orderData.payment_amount = totalAmount;
            }
        } else if (orderData.payment_status === 'Paid') {
            // For paid orders, automatically set payment amount to total
            orderData.payment_amount = totalAmount;
        }
        
        $.ajax({
            url: '/api/orders',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(orderData),
            success: function(response) {
                showAlert('Order created successfully!', 'success');
                $('#addOrderModal').modal('hide');
                $('#addOrderForm')[0].reset();
                $('#orderItems').html($('#orderItems .order-item').first().clone());
                $('#orderDate').val(new Date().toISOString().split('T')[0]);
                loadOrders();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to create order.';
                showAlert(error, 'danger');
                // Reset payment fields on error to prevent validation issues
                $('#paymentAmount').val('');
                $('#paymentStatus').val('Unpaid');
                $('#paymentAmountRow').hide();
                calculateOrderTotal(); // Recalculate total to ensure consistency
                
                // Ensure payment amount field is hidden after error
                $('#paymentAmountRow').hide();
            }
        });
    });
    
    // View order
    $(document).on('click', '.view-order', function() {
        const orderId = $(this).data('order-id');
        loadOrderDetails(orderId);
    });
    
    // Edit order status
    $(document).on('click', '.edit-order-status', function() {
        const orderId = $(this).data('order-id');
        const currentStatus = $(this).data('status');
        
        $('#editOrderId').val(orderId);
        $('#editPaymentStatus').val(currentStatus);
        $('#editOrderStatusModal').modal('show');
    });
    
    // Update order status
    $('#updateOrderStatusBtn').click(function() {
        const orderId = $('#editOrderId').val();
        const paymentStatus = $('#editPaymentStatus').val();
        
        $.ajax({
            url: `/api/orders/${orderId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ payment_status: paymentStatus }),
            success: function(response) {
                showAlert('Order status updated successfully!', 'success');
                $('#editOrderStatusModal').modal('hide');
                loadOrders();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to update order status.';
                showAlert(error, 'danger');
            }
        });
    });
    
    // Delete order
    $(document).on('click', '.delete-order', function() {
        const orderId = $(this).data('order-id');
        
        // Reset any previous button states
        $('#confirmDeleteOrderBtn').prop('disabled', false);
        $('#confirmDeleteOrderBtn').html('<i class="fas fa-trash me-2"></i>Delete Order');
        
        $('#deleteOrderModal').modal('show');
        $('#confirmDeleteOrderBtn').data('order-id', orderId);
    });
    
    // Confirm delete
    $('#confirmDeleteOrderBtn').click(function() {
        const orderId = $(this).data('order-id');
        
        // Disable button to prevent double-clicking
        const $btn = $(this);
        $btn.prop('disabled', true);
        $btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Deleting...');
        
        $.ajax({
            url: `/api/orders/${orderId}`,
            method: 'DELETE',
            success: function(response) {
                showAlert(response.message || 'Order deleted successfully!', 'success');
                $('#deleteOrderModal').modal('hide');
                loadOrders();
                
                // Reset button state
                $btn.prop('disabled', false);
                $btn.html('<i class="fas fa-trash me-2"></i>Delete Order');
            },
            error: function(xhr) {
                let errorMessage = 'Failed to delete order.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.status === 500) {
                    errorMessage = 'Server error occurred while deleting order. Please try again.';
                } else if (xhr.status === 404) {
                    errorMessage = 'Order not found. It may have been deleted already.';
                }
                showAlert(errorMessage, 'danger');
                
                // Re-enable button
                $btn.prop('disabled', false);
                $btn.html('<i class="fas fa-trash me-2"></i>Delete Order');
            }
        });
    });
    
    // Reset button state when modal is hidden
    $('#deleteOrderModal').on('hidden.bs.modal', function() {
        const $btn = $('#confirmDeleteOrderBtn');
        $btn.prop('disabled', false);
        $btn.html('<i class="fas fa-trash me-2"></i>Delete Order');
    });
    
    function calculateOrderTotal() {
        let total = 0;
        $('.order-item').each(function() {
            const price = parseFloat($(this).find('.product-select option:selected').data('price')) || 0;
            const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
            const itemTotal = price * quantity;
            
                            $(this).find('.total-display').val(`₹${itemTotal.toFixed(2)}`);
            total += itemTotal;
        });
        
                    $('#orderTotal').text(`₹${total.toFixed(2)}`);
    }
    
    function loadOrders() {
        $.get('/api/orders')
            .done(function(data) {
                orders = data;
                renderOrdersTable(data);
            })
            .fail(function() {
                showAlert('Failed to load orders.', 'danger');
            });
    }
    
    function loadCustomers() {
        $.get('/api/customers')
            .done(function(data) {
                customers = data;
            })
            .fail(function() {
                showAlert('Failed to load customers.', 'danger');
            });
    }
    
    function loadProducts() {
        $.get('/api/products')
            .done(function(data) {
                products = data;
            })
            .fail(function() {
                showAlert('Failed to load products.', 'danger');
            });
    }
    
    function loadOrderDetails(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (order) {
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Order ID:</strong> #${order.id}</p>
                        <p><strong>Customer:</strong> ${order.customer_name}</p>
                        <p><strong>Order Date:</strong> ${order.order_date}</p>
                        <p><strong>Delivery Date:</strong> ${order.delivery_date || 'Not specified'}</p>
                        <p><strong>Payment Status:</strong> 
                            <span class="badge ${order.payment_status === 'Paid' ? 'bg-success' : order.payment_status === 'Partial' ? 'bg-warning' : 'bg-danger'}">
                                ${order.payment_status}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Order Items</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            order.items.forEach(item => {
                html += `
                    <tr>
                        <td>${item.product_name}</td>
                        <td>${item.quantity}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td>₹${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <th colspan="3">Total Amount</th>
                                        <th>₹${order.total_amount.toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            $('#viewOrderContent').html(html);
            $('#viewOrderModal').modal('show');
        }
    }
    
    function renderOrdersTable(ordersData) {
        if (ordersData.length === 0) {
            $('#ordersTableBody').html(`
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p class="mb-0">{{ t('no_orders_found') }}</p>
                        </div>
                    </td>
                </tr>
            `);
            return;
        }
        
        let html = '';
        ordersData.forEach(order => {
            const statusClass = order.payment_status === 'Paid' ? 'bg-success' : 
                              order.payment_status === 'Partial' ? 'bg-warning' : 'bg-danger';
            
            html += `
                <tr data-order-id="${order.id}">
                    <td>#${order.id}</td>
                    <td>${order.customer_name}</td>
                    <td>${order.order_date}</td>
                    <td>${order.delivery_date || '-'}</td>
                                            <td>₹${order.total_amount.toFixed(2)}</td>
                    <td>
                        <span class="badge ${statusClass}">${order.payment_status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info view-order" 
                                data-order-id="${order.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary edit-order-status" 
                                data-order-id="${order.id}"
                                data-status="${order.payment_status}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="/invoice/${order.id}" class="btn btn-sm btn-outline-success" title="Generate Invoice">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-danger delete-order" 
                                data-order-id="${order.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        $('#ordersTableBody').html(html);
    }
    
    function filterOrders(searchTerm) {
        const filtered = orders.filter(order => 
            order.customer_name.toLowerCase().includes(searchTerm) ||
            order.id.toString().includes(searchTerm)
        );
        renderOrdersTable(filtered);
    }
    

});
</script>
{% endblock %}
